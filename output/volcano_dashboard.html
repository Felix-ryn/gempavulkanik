<!doctype html>
<html lang="id">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>VolcanoAI Dashboard (Local)</title>

    <!-- Bootstrap -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Leaflet -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

    <style>
        body {
            background: #f3f6f8;
        }

        .sidebar {
            width: 320px;
            min-height: 100vh;
            padding: 20px;
        }

        #map {
            height: 75vh;
            border-radius: 6px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.25);
        }

        .card-small {
            margin-bottom: 16px;
        }

        .status-badge {
            font-size: 1.6rem;
            font-weight: 700;
        }

        .muted-label {
            color: #6c757d;
            font-size: 0.9rem;
        }

        .value {
            font-weight: 600;
        }
    </style>
</head>
<body>
    <div class="container-fluid">
        <div class="row">
            <!-- SIDEBAR -->
            <aside class="col-auto sidebar bg-white">
                <h4 class="mb-3">VolcanoAI LIVE MONITOR</h4>

                <div class="card card-small p-3">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <div class="muted-label">Status Prediksi</div>
                            <div id="pred-status" class="status-badge text-success">--</div>
                        </div>
                        <div>
                            <span id="system-badge" class="badge bg-danger">System Active</span>
                        </div>
                    </div>
                    <hr />
                    <div class="muted-label">Lokasi (lat, lon)</div>
                    <div id="loc" class="value mb-2">- , -</div>

                    <div class="muted-label">Waktu</div>
                    <div id="ts" class="value mb-2">-</div>

                    <div class="muted-label">Rows (n_events)</div>
                    <div id="rows" class="value">-</div>
                </div>

                <div class="card card-small p-3">
                    <h6>Detail Prediksi</h6>
                    <div class="muted-label">Arah / Gerakan</div>
                    <div id="dir" class="value mb-2">-</div>

                    <div class="muted-label">Jarak (km)</div>
                    <div id="dist" class="value mb-2">-</div>

                    <div class="muted-label">Confidence</div>
                    <div id="conf" class="value mb-2">-</div>

                    <div class="muted-label">Seismic</div>
                    <div id="seismic" class="value mb-2">-</div>
                </div>

                <div class="card card-small p-3">
                    <h6>Pengaturan</h6>
                    <div class="form-text mb-2">Polling interval (detik)</div>
                    <input id="interval" type="number" class="form-control mb-2" value="10" min="1" />
                    <button id="btnApply" class="btn btn-sm btn-primary">Apply</button>
                    <div class="form-text mt-2 text-muted">
                        Pastikan file JSON dapat diakses melalui HTTP (http://localhost:8000/...)
                    </div>
                </div>
            </aside>

            <!-- MAIN -->
            <main class="col ps-4 pe-4">
                <div class="mb-3">
                    <div id="map"></div>
                </div>
            </main>
        </div>
    </div>

    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        // ===== CONFIGURATION =====
        let DATA_PATH = 'http://localhost:8000/cnn_results/cnn_predictions_latest.json';
        let POLL_MS = 10000;

        // Leaflet map
        const map = L.map('map', { zoomControl: true }).setView([-7.97, 112.38], 9);
        L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}.png', {
            attribution: '&copy; OpenStreetMap contributors & CARTO'
        }).addTo(map);

        let eventMarker = null;
        let rangeCircle = null;

        function formatTimestamp(ts) {
            try { return new Date(ts).toLocaleString(); }
            catch (e) { return ts; }
        }

        function updateUI(data) {
            if (!data) return;
            const ne = data.next_event || {};
            const lat = ne.lat ?? '-';
            const lon = ne.lon ?? '-';

            // Update sidebar
            document.getElementById('loc').textContent = `${lat}, ${lon}`;
            document.getElementById('ts').textContent = formatTimestamp(data.timestamp || '-');
            document.getElementById('rows').textContent = data.rows ?? '-';
            document.getElementById('dir').textContent = `${ne.direction_deg ?? '-'}Â° ${ne.movement ?? '-'}`;
            document.getElementById('dist').textContent = (ne.distance_km !== undefined) ? `${ne.distance_km} km` : '-';
            document.getElementById('conf').textContent = (ne.confidence !== undefined) ? `${ne.confidence}` : '-';
            document.getElementById('seismic').textContent = (ne.seismic !== undefined) ? `${ne.seismic}` : '-';

            // Status mapping
            const statusEl = document.getElementById('pred-status');
            switch ((data.status || '').toLowerCase()) {
                case 'ok': statusEl.textContent = 'Ringan'; statusEl.className = 'status-badge text-success'; break;
                case 'warning': statusEl.textContent = 'Siaga'; statusEl.className = 'status-badge text-warning'; break;
                case 'critical': statusEl.textContent = 'Bahaya'; statusEl.className = 'status-badge text-danger'; break;
                default: statusEl.textContent = data.status || '-'; statusEl.className = 'status-badge text-secondary';
            }

            // Map marker & circle
            if (ne.lat != null && ne.lon != null) {
                const latlng = [ne.lat, ne.lon];
                if (!eventMarker) {
                    eventMarker = L.circleMarker(latlng, { radius: 10, color: '#ff2e2e', fillColor: '#ff2e2e', fillOpacity: 1 }).addTo(map);
                } else eventMarker.setLatLng(latlng);

                const radiusMeters = (ne.distance_km !== undefined && !isNaN(ne.distance_km)) ? ne.distance_km * 1000 : 20000;
                if (!rangeCircle) {
                    rangeCircle = L.circle(latlng, { radius: radiusMeters, color: '#8b32ff', fillColor: '#8b32ff', fillOpacity: 0.12 }).addTo(map);
                } else {
                    rangeCircle.setLatLng(latlng);
                    rangeCircle.setRadius(radiusMeters);
                }

                const popupHtml = `
              <b>LIVE ALERT</b><br>
              Lat/Lon: ${ne.lat}, ${ne.lon}<br>
              Distance: ${ne.distance_km ?? '-'} km<br>
              Confidence: ${ne.confidence ?? '-'}<br>
              Seismic: ${ne.seismic ?? '-'}
            `;
                eventMarker.bindPopup(popupHtml);

                if (map.getZoom() < 10) map.setView(latlng, 10, { animate: true });
            }
        }

        // Fetch JSON and update
        async function fetchData() {
            try {
                const res = await fetch(DATA_PATH + '?_=' + Date.now());
                if (!res.ok) throw new Error('HTTP ' + res.status);
                const json = await res.json();
                updateUI(json);
            } catch (err) {
                console.error('Gagal memuat JSON:', err);
            }
        }

        // Initial load
        fetchData();

        // Polling
        let pollHandle = setInterval(fetchData, POLL_MS);

        // Update polling interval
        document.getElementById('btnApply').addEventListener('click', () => {
            const v = parseInt(document.getElementById('interval').value || '10', 10);
            if (isNaN(v) || v < 1) return alert('Masukkan angka > 0');
            POLL_MS = v * 1000;
            clearInterval(pollHandle);
            pollHandle = setInterval(fetchData, POLL_MS);
            alert('Interval diperbarui ke ' + v + ' detik');
        });

        window.__VOLCANO = { fetchData, updateUI, map };
    </script>
</body>
</html>
